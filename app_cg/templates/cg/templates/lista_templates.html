{% extends 'cg/base.html' %}

{% block conteudo %}
<div class="">
    <section class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1>Gerenciar Templates</h1>
                </div>
            </div>
        </div>
    </section>

    <section class="content">
        <div class="container-fluid">
            <div class="row mb-3">
                <div class="col-12 text-right">
                    <button type="button" class="btn btn-success" data-toggle="modal" data-target="#modal">
                        <i class="fas fa-plus"></i> Novo Template
                    </button>
                </div>
            </div>
            
            <!-- <input type="text" id="busca-cards" placeholder="Buscar..."> -->

            <div id="cards-container" class="row">
                {% if not templates %}
                    <div class="col-12 text-center">
                        <p class="text-muted">Nenhum template cadastrado ainda.</p>
                    </div>
                {% else %}
                    {% for t in templates %}
                    <div class="col-md-6 card-item">
                        <div class="card card-primary card-outline">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h3 class="card-title flex-grow-1"><strong>{{ t.nome }}</strong></h3>
                                <div class="card-tools text-end d-flex gap-1">
                                    <button type="button" class="btn btn-sm btn-danger mr-1" data-toggle="modal" data-target="#deleteModal{{ t.codtemplate }}" title="Excluir">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                    {% if t.template_url %}
                                        <!-- <a href="{{ t.template.url }}" download="{{ t.nome }}.docx" class="">
                                            <button type="button" class="btn btn-info btn-sm custom-primary-link">
                                                <i class="fas fa-download"></i>
                                            </button>
                                        </a> -->
                                        <form method="POST" action="{% url 'baixar_template' %}">
                                            {% csrf_token %}
                                            <input type="hidden" name="codtemplate" value="{{ t.codtemplate }}">
                                            <button type="submit" class="btn btn-info btn-sm mr-1" id="bt_n_download">
                                                <i class="fas fa-download"></i>
                                            </button>
                                        </form>
                                    {% else %}
                                        <a href="#" class="">
                                            <button type="button" class="btn btn-info btn-sm" disabled>
                                                <i class="fas fa-download"></i>
                                            </button>
                                        </a>
                                    {% endif %}
                                    <!-- <button type="button" class="btn btn-sm btn-primary" data-toggle="modal" data-target="#modalCadastro" 
                                            data-nome="{{ t.nome|escapejs }}" 
                                            data-descricao="{{ t.descricao|escapejs }}" 
                                            data-codtemplate="{{ t.codtemplate|escapejs }}"
                                            title="Editar">
                                        <i class="fas fa-edit"></i>
                                    </button> -->

                                    <button type="button" class="btn btn-primary btn-sm custom-primary-link" data-toggle="modal" 
                                    data-target="#modal" id="editModalBtn" name="editModalBtn" 
                                    onclick="editarTemplate('{{ t.nome|escapejs }}', '{{ t.descricao|escapejs }}', '{{ t.codtemplate|escapejs }}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <p class="card-text">
                                    {{ t.descricao|default:"Sem descrição." }}
                                </p>
                                <a href="{% url 'gerenciar_variaveis' t.codtemplate %}" class="btn btn-sm btn-outline-secondary mt-2" id="btn_gerenciar-variaveis">
                                    <i class="fas fa-sliders-h"></i> Variáveis
                                </a>
                                <a href="{% url 'form_contrato' t.codtemplate %}" class="btn btn-sm btn-success mt-2 float-right" id="btn_form-contrato">
                                    <i class="fas fa-file-alt"></i> Usar Template
                                </a>
                            </div>
                            <div class="card-footer text-muted text-sm">
                                {{ t.dtatualiz|date:"d/m/Y H:i" }}
                            </div>
                        </div>
                    </div>

                    <div class="modal fade" id="deleteModal{{ t.codtemplate }}">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <form method="POST" action="{% url 'deletar_template' %}">
                                    {% csrf_token %}
                                    <input type="hidden" name="deletar-codtemplate" value="{{ t.codtemplate }}">
                                    <div class="modal-header bg-danger">
                                        <h5 class="modal-title">Atenção</h5>
                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                            <span aria-hidden="true">&times;</span>
                                        </button>
                                    </div>
                                    <div class="modal-body">
                                        <p>Tem certeza que deseja <strong>excluir</strong> o template "{{ t.nome }}"?</p>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Não</button>
                                        <button type="submit" class="btn btn-danger" id="btn_excluir-template">Sim, Excluir</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% endif %}
            </div>
        </div>
        
        <div class="bottom-0 start-0 end-0 p-3 bg-light" style="z-index: 1050;">
            <button onclick="history.back()" type="button" class="btn btn-secondary"><i class="fas fa-reply"></i> Voltar</button>                
        </div>
    </section>
</div>

<div class="modal fade" id="modal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
            <form id="templateForm" method="post" enctype="multipart/form-data" action="{% url 'cadastrar_template' %}">
                {% csrf_token %}
                <div class="modal-header">
                    <h4 class="modal-title" id="modalTitle">Novo Template</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="limparTemplate()">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="operacao" id="operacao" value="0">
                    <input type="hidden" name="codtemplate" id="codtemplate" value="0">
                    <div class="form-group">
                        <label for="nome">Nome</label>
                        <input type="text" class="form-control" name="nome" id="nome" placeholder="Nome do template" maxlength="100" required>
                        <div id="nome-erro" class="invalid-feedback" style="display: none;">Campo obrigatório!</div>
                    </div>

                    <div class="form-group">
                        <label for="descricao">Descrição</label>
                        <input type="text" class="form-control" name="descricao" id="descricao" maxlength="255" placeholder="Descrição breve do template">
                    </div>
                    <div class="form-group">
                        <label for="template">Arquivo Template (.docx)</label>
                        <div class="custom-file">
                           <input type="file" class="custom-file-input" name="template" id="template" accept=".docx" required>
                           <label class="custom-file-label" for="template">Escolher arquivo...</label>
                        </div>
                        <small id="fileHelp" class="form-text text-muted">Utilizar apenas formato (.docx)</small>
                        <!-- <small id="fileHelp" class="form-text text-muted">Na edição, envie um arquivo apenas se desejar substituí-lo.</small> -->
                    </div>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-default" data-dismiss="modal" onclick="limparTemplate()">Fechar</button>
                    <button type="submit" class="btn btn-primary" id="btn_salvar-template">Salvar</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}

<script>

    /////////////////// PESQUISA ELEMENTOS NA PÁGINA
    $(document).ready(function(){
        $('#searchInput').on('keyup', function(){
            let value = $(this).val().toLowerCase();

            $('#cardsContainer .card-item').filter(function(){
            $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
            });
        });
    });
    
    /////////////////// BOTÃO DE EDITAR
    // Utilizado para novo cadastro
    function editarTemplate(nome, descricao, codtemplate) {
        document.getElementById("nome").value = nome;
        document.getElementById("descricao").value = descricao;
        document.getElementById("codtemplate").value = codtemplate;
        document.getElementById("operacao").value = 1;
        validarNome();
    }
    // Utilizado para edição de cadastro existente
    function limparTemplate() { // Caso feche a modal sem salvar 
        document.getElementById("nome").value = "";
        document.getElementById("descricao").value = "";
        document.getElementById("codtemplate").value = "0";
        document.getElementById("operacao").value = "0";
        validarNome();
    }
    // Captura o evento de fechamento do modal (por X, botão ou ESC)
    document.addEventListener("DOMContentLoaded", function () {
        const modal = document.getElementById("modal");
        modal.addEventListener("hidden.bs.modal", function () {
            limparTemplate();
        });
    });

    /////////////////// CAMPO INPUT DE ARQUIVO
    document.getElementById('template').addEventListener('change', function () {
        const file = this.files[0];
        if (file && !file.name.endsWith('.docx')) {
            alert('Somente arquivos ".docx" são permitidos.');
            this.value = ''; // Limpa o campo
        }
    });
    $(document).ready(function () {
        // Validar se o template está vazio, pois é obrigatório
        function validarTemplate() {
            var name = $('#template').val();

            if (name === '') {
                $('#template-erro').show();
                $('#template').addClass('is-invalid');
                return false;
            } else {
                $('#template-erro').hide();
                $('#template').removeClass('is-invalid').addClass('is-valid');
                return true;
            }
        }
        // Validação contínua enquanto o usuário digita (corrige o erro enquanto ele digita)
        $('#template').on('input', function () {
            validarTemplate();
        });
        // Chamar a função quando carregar a página
        validarTemplate();
    });
    $(document).ready(function () {
        $('.custom-file-input').on('change', function () {
            let fileName = $(this).val().split('\\').pop();
            $(this).siblings('.custom-file-label').addClass("selected").html(fileName);
        });
    });

    /////////////////// CAMPO NOME
    // Validar se o nome está vazio, pois é obrigatgório
    function validarNome() {
        var name = $('#nome').val();

        if (name === '') {
            $('#nome-erro').show();
            $('#nome').addClass('is-invalid');
            return false;
        } else {
            $('#nome-erro').hide();
            $('#nome').removeClass('is-invalid').addClass('is-valid');
            return true;
        }
    }
    $(document).ready(function () {
        // Enquanto digita
        $('#nome').on('input', function () {
            validarNome();
        });

        // Validação inicial
        validarNome();
    });

    // BUSCAR NO TEMPLATE USANDO DATATABLES
    $(document).ready(function () {
        // Cria um DataTable virtual com os dados dos cards
        var dataSet = [];
        $("#cards-container .card-item").each(function () {
            let title = $(this).find(".card-title").text();
            let desc = $(this).find(".card-text").text();
            dataSet.push([title, desc]); // cada card = uma linha
        });

        var table = $('#hiddenTable').DataTable({
            data: dataSet,
            searching: true,
            paging: false,
            info: false,
            dom: 't' // oculta header/paginação
        });

        // Linka o input de busca ao DataTables
        $('#busca-cards').on('keyup', function () {
            table.search(this.value).draw();

            // Esconde/mostra os cards com base na busca
            $("#cards-container .card-item").each(function (index) {
                if (table.rows({ search: 'applied' }).indexes().toArray().includes(index)) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        });
    });
</script>

<!-- <script>
$(document).ready(function () {
    // Limpa e reseta o modal quando ele é aberto
    $('#modalCadastro').on('show.modal', function (event) {
        var button = $(event.relatedTarget); // Botão que acionou o modal
        var form = $('#templateForm');
        var modal = $(this);

        // Resgata os dados do botão de edição
        var nome = button.data('nome');
        var descricao = button.data('descricao');
        var codtemplate = button.data('codtemplate');

        form.trigger('reset'); // Limpa o formulário
        modal.find('.custom-file-label').text('Escolher arquivo...');
        form.find('input').removeClass('is-invalid is-valid');

        if (codtemplate) { // Modo de Edição
            modal.find('.modal-title').text('Editar Template');
            modal.find('#nome').val(nome);
            modal.find('#descricao').val(descricao);
            modal.find('#codtemplate').val(codtemplate);
            modal.find('#operacao').val(1);
            modal.find('#template').prop('required', false); // Arquivo não é obrigatório na edição
        } else { // Modo de Cadastro
            modal.find('.modal-title').text('Novo Template');
            modal.find('#codtemplate').val(0);
            modal.find('#operacao').val(0);
            modal.find('#template').prop('required', true); // Arquivo é obrigatório no cadastro
        }
    });

    // Mostra o nome do arquivo selecionado no input de arquivo
    $('.custom-file-input').on('change', function(event) {
        var fileName = event.target.files[0].name;
        $(this).next('.custom-file-label').html(fileName);
    });
});
</script>-->
{% endblock %}